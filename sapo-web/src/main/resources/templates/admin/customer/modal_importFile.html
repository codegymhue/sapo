<th:block th:fragment="modalImportFileCustomers">
    <link rel="stylesheet" href="/static/assets/admin/css/customer/loading.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.min.js"></script>  
    <div class="modal fade" id="modalImportFileCustomers" data-bs-backdrop="static" data-bs-keyboard="false"
         tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Nhập file dữ liệu khách hàng</h1>

                    <span class="loader" style="z-index: -1"></span>

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="MuiTypography-root MuiTypography-subtitle1">Chú ý:</h6>
                    <div class="py-2 mx-3" style="width: 96%; background-color: #ffc0cb6b; height: 70px; border-radius: 10px;">
                        <svg class="mx-4 my-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                             font-size="24" color="error" style="float: left">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                  d="M2.734 21.002a1 1 0 0 1-.865-1.501l9.265-16.004a1 1 0 0 1 1.731 0L22.131 19.5a1 1 0 0 1-.866 1.501H2.735ZM13 18h-.935a.992.992 0 0 1-.13 0H11v-2h2v2Zm0-3.998h-2v-5h2v5Z"
                                  fill="#FF4D4D">
                            </path>
                        </svg>
                        <div class="MuiBox-root jss2607" style="margin-left: 20px;">
                          <span class="MuiTypography-root MuiTypography-body2">Mẫu nhập file khách hàng đã được thay đổi vào
                            <span class="MuiTypography-root MuiTypography-body1"
                                  style="font-weight: 500;"> 01/01/2023</span>
                          </span>
                            <p class="MuiTypography-root MuiTypography-body2">Bạn vui lòng kiểm tra và tải lại file mới
                                để tránh sai lệch dữ liệu</p>
                        </div>
                    </div>
                    <form id="frmFileCustomers" method="post">
                        <div>
                            <ul class="my-3" style="font-size: 14px">
                                <li>
                                    <span>Tải File mẫu <a target="_blank" href="/assets/admin/files/file_nhap_mau_khach_hang.xlsx" download style="text-decoration: none">tại đây</a> (cập nhật ngày: 01/01/2023)</span>
                                </li>
                                <li>
                                   <span>File có dung lượng tối đa là 2MB và 5000 dòng</span>
                                </li>
                            </ul>
                            <label class="mb-3">Nhập file vào đây</label>
                            <input class="form-control" type="file" id="formFileCustomers">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="cancelToReset()" class="btn-outline-primary" data-bs-dismiss="modal" style="border: 1px solid #bdbdbd;
                                                                                             padding: 6px 12px;
                                                                                             border-radius: 6px;
                                                                                             font-weight: 500;">Thoát
                    </button>
                    <button type="button" id="btnImportFileCustomers" class="btn-primary" style="border: 1px solid lightseagreen;
                                                                                             padding: 6px 12px;
                                                                                             border-radius: 5px;
                                                                                             font-weight: 500;">
                        Nhập file
                </div>
            </div>
        </div>
    </div>
    <script>
        {
        let statusLoading = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                             <span class="sr-only">Loading...</span>`;
        let errorArrRow = [];
        let listCreateCustomerParam = [];
        let listObjAddress = {};
        let listResultParam = [];
        
        let flag = false;
        let obj = {};
        let countSuccess = 0;
        let countFailure = 0;
        let sheetName = "";
        $('#btnImportFileCustomers').on('click',() => {
            listCreateCustomerParam = [];
            flag = false;
            errorArrRow = [];
            listResultParam = [];
            listObjAddress = {};
            countSuccess = 0;
            countFailure = 0;

            $("#customer-series-update").html("");
            $('#btnImportFileCustomers').attr('disabled',true);
            $('#comfirm-alert-series-customer').attr('disabled', true);
            $('#btnImportFileCustomers').html(statusLoading);
            $('#comfirm-alert-series-customer').html(statusLoading);

            upload();
            try{
                let setData = setInterval(()=>{
                if(flag){
                    let datas = obj[sheetName];
                    for(let i=0; i<datas.length; i++){
                        validateDataExcel(datas[i], i);
                        excelToCreateCustomerParam(datas[i]);
                    }
                    createListAddress(listCreateCustomerParam);
                    createListResult(listCreateCustomerParam, errorArrRow, listObjAddress);
                    createListAddress(listResultParam);
                    if(errorArrRow.length==0){
                        createSeriesCustomer(listResultParam, listObjAddress);
                    }else{
                        renderError(errorArrRow);
                    }

                    // console.log(listCreateCustomerParam);
                    // console.log(errorArrRow);
                    // console.log(listObjAddress);
                    // console.log(listResultParam);

                    $("#modalImportFileCustomers").modal("hide");
                    $("#modal-alert-series-customer").modal('show');
                    $('#btnImportFileCustomers').text('Nhập file')
                    $('#btnImportFileCustomers').attr('disabled',false);
                    $('#comfirm-alert-series-customer').text('Xác nhận');
                    $('#comfirm-alert-series-customer').attr('disabled', false);
                    $("#frmFileCustomers")[0].reset();

                    clearInterval(setData);
                }
                });
            }catch{
                clearInterval(setData);
            }
        });
        //reset form khi nhan thoat
        function cancelToReset(){
            $("#frmFileCustomers")[0].reset();
        }
        function renderError(listError){
            $(`#show-detai-failure-series-customer`).html("");
            $("#count-failure").text(0);
            for(let error of listError){
                let index = Object.keys(error)[0];
                let indexMessage = error[index];
                countFailure++;
                $("#count-failure").text(countFailure);
                let elementRowError = `<div class="customer-series-update" id=error-excel-${countFailure}><h5>Hàng ${Number(index)+1}: </h5></div>`
                $(`#show-detai-failure-series-customer`).append(elementRowError);
                for(let message in indexMessage){
                    let content = `<div>- ${message}: ${indexMessage[message]}</div>`;
                    $(`#error-excel-${countFailure}`).append(content);
                }
            }
        }
        
        //loc data Excel
        function createListResult(listCreateCustomerParam, errorArrRow, listObjAddress){
            for(let i=0; i<listCreateCustomerParam.length; i++){ 
                let index = i;
                let indexError = [];
                let indexListCreate = [];
                for(let a=0; a<errorArrRow.length; a++){
                    indexError.push(Object.keys(errorArrRow[a])[0]);
                }
                if(!indexError.includes(`${i}`) && !Object.keys(listObjAddress).includes(`${i}`)){
                    listResultParam.push(listCreateCustomerParam[i]);
                }
                let flag = false;
                if(Object.keys(listObjAddress).includes(`${i}`)){
                    if(Object.keys(errorArrRow).includes(`${i}`)){
                        i+=listObjAddress[i].length;
                    }else{
                        for(let j=0; j<listObjAddress[i].length; j++){
                            index++;
                            if(indexError.includes(`${index}`)){
                                i+=listObjAddress[i].length;
                                break;
                            }else if(j==listObjAddress[i].length-1){
                                flag = true;
                            }
                        }
                    }
                }
                if(flag){
                    indexListCreate.push(i);
                }
                for(let item of indexListCreate){
                    let index = item;
                    for(let x=0; x<=listObjAddress[item].length; x++){
                        listResultParam.push(listCreateCustomerParam[index])
                        index++;
                    }
                    i+=listObjAddress[item].length;
                }
            }
            // console.log("index")
            // console.log(indexListCreate)
        }
        // tao customer hang loat
        function createSeriesCustomer(data, contact){  
            let address = Object.keys(contact);
            let countSuccess = 0;
            $("#show-detai-success-series-customer").html("");
            $("#count-success").text(countSuccess);
            for(let i=0; i<data.length; i++){
                if(address.includes(`${i}`)){
                    createCustomerManyContact(data[i], contact[i]);
                }else{
                    if(data[i]["fullName"] != ''){
                        createCustomerOneContact(data[i]);
                    }
                }
            }
            CustomerApp.IziToast.showSuccessAlert("Tải file lên thành công!")
        }
        //tao listcontact tuong ung voi tung customer
        function createListAddress(arr){
            listObjAddress = {};
            for(let i=0; i<arr.length-1; i++){
                let address = [];
                if(arr[i+1]["fullName"] != ''){
                    continue;
                }else{
                    let j=i;
                    do{
                        if(arr[i]["fullName"]==''){
                            address.push(arr[i]["createAddressParam"]);
                        }
                        if(i<arr.length-1){
                            i++;
                        }else{
                            break;
                        }
                    }while(arr[i]["fullName"]=='');
                    --i;
                    listObjAddress[j] = address;
                }
            }
            // return listObjAddress;
        }
        //tao 1 customer voi 1 dia chi lien he
        function createCustomerOneContact(customer){
            $.ajax({
                headers: {          
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                async: false,
                type:"POST",
                url: origin + '/api/customers',
                data: JSON.stringify(customer),
            })
            .done((result)=>{
                
                let content =`<div class="customer-series-update">
                                <a href="/admin/customers/${result.id}">${result.fullName}</a> - Đã được tạo thành công
                             </div>`
                $("#count-success").text(++countSuccess);
                $("#show-detai-success-series-customer").append(content);
                let data = 
                console.log("fullName: ")
                console.log({fullName: result.addresses[0].fullName});
                // $.ajax({
                //     headers: {          
                //         "accept": "application/json",
                //         "content-type": "application/json"
                //     },
                //     async:false,
                //     type:"POST",
                //     url: origin + `/api/customers/${result.id}/contacts`,
                //     data: JSON.stringify({fullName: result.addresses[0].fullName})
                // });
            })
            // console.log("customer: ");
            // console.log(customer);
        }
        //tao 1 customer voi nhieu dia chi lien he
        function createCustomerManyContact(customer, contact){
            // console.log("customer: ");
            // console.log(customer);
            $.ajax({
                headers: {          
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                async: false,
                type:"POST",
                url: origin + '/api/customers',
                data: JSON.stringify(customer),
            })
            .done((result)=>{
                let content =`<div class="customer-series-update">
                                <a href="/admin/customers/${result.id}">${result.fullName}</a> - Đã được tạo thành công
                             </div>`
                $("#count-success").text(++countSuccess);
                $("#show-detai-success-series-customer").append(content);

                let listContactData = result.addresses.map((address)=>{
                        return address.fullName;
                })

                for(let i=0; i<contact.length; i++){
                    $.ajax({
                        headers: {          
                            "accept": "application/json",
                            "content-type": "application/json"
                        },
                        async:false,
                        type:"POST",
                        url: origin + '/api/addresses',
                        data: JSON.stringify({...contact[i], customerId: result.id})
                    });
                }
                // console.log("listContactData");
                // console.log(listContactData);
                for(let i=0; i<listContactData.length; i++){
                    $.ajax({
                        headers: {          
                            "accept": "application/json",
                            "content-type": "application/json"
                        },
                        async:false,
                        type:"POST",
                        url: origin + `/api/customers/${result.id}/contacts`,
                        data: JSON.stringify({fullName: listContactData[i].fullName})
                    })
                }
                // .done((result)=>{
                //     console.log(result);
                // })
                // console.log("contact: ");
                // console.log(contact);
            })
        }
        //validate data excel
        function validateDataExcel(data, index){
            let validate = {
                ["Tên khách hàng"]: {
                    empty: {
                        value: true
                    },
                    regex: {
                        value: /^.{0,255}$/,
                        message: "Độ dài tên khách hàng lớn hơn 255 kí tự"
                    }
                },
                ["Mã khách hàng"]:{
                    empty: {
                        value: true
                    },
                    regex: {
                        value: /^.{1-255}$/,
                        message: "Độ dài mã khách hàng lớn hơn 255 kí tự"
                    }
                },
                ["Mã nhóm khách hàng"]:{
                    empty: {
                        value: true
                    },
                    regex: {
                        value: /^[0-9][1-9]*$/,
                        message: "Mã nhóm khách hàng phải là một số"
                    }
                },
                ["Áp dụng ưu đãi"]: {
                    empty: {
                        value: true
                    }
                },
                ["Email"]: {
                    empty:{
                        value: true
                    }
                },
                ["Điện thoại"]: {
                    empty:{
                        value: true
                    },
                    regex: {
                        value: /^[0-9]*$/,
                        message: "Điện thoại không phải là số"
                    }
                },
                ["Ngày sinh"]:{
                    empty:{
                        value: true
                    }
                },
                ["Giới tính"]:{
                    empty: {
                        value: true
                    }
                },
                ["Website"]:{
                    empty:{
                        value: true
                    },
                },
                ["Fax"]:{
                    empty:{
                        value: true
                    },
                    regex: {
                        value: /^[0-9]*$/,
                        message: "Fax không phải là số"
                    }
                },
                ["Mã số thuế"]:{
                    empty:{
                        value: true
                    },
                    
                    regex:{
                        value: /^[0-9]*$/,
                        message: "Mã số thuế không đúng định dạng"
                    }
                },
                ["SĐT nhân viên phụ trách"]:{
                    empty:{
                        value: true
                    },
                    regex:{
                        value: /^[0-9]*$/,
                        message: "Số điện thoại nhân viên phụ trách không đúng định dạng"
                    }
                },
                ["Mô tả"]:{
                    empty:{
                        value: true
                    },
                },
                ["Chính sách giá mặc định"]:{
                    empty:{
                        value: true
                    },
                },
                ["Chiết khấu mặc định (%)"]:{
                    empty:{
                        value: true
                    },
                    regex:{
                        value: /^([0-9]|[1-9][0-9])$/,
                        message: "Chiết khấu mặc định không đúng định dạng"
                    }
                },
                ["Phương thức thanh toán mặc định"]:{
                    empty:{
                        value: true
                    }
                },
                ["Người liên hệ"]:{
                    empty:{
                        value: false,
                        message: "Người liên hệ bị trống",
                    },
                },
                ["Người liên hệ - SĐT"]:{
                    empty:{
                        value: false,
                        message: "Người liên hệ - SĐT bị trống"
                    },
                    regex:{
                        value: /^[0-9]*$/,
                        message: "Người liên hệ - SĐT không đúng định dạng"
                    }
                },
                ["Người liên hệ - Email"]:{
                    empty:{
                        value: false,
                        message: "Email người liên hệ bị trống",
                    },
                    regex:{
                        value: /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
                        message: "Email người liên hệ không đúng định dạng"
                    }
                },
                ["Địa chỉ"]:{
                    empty:{
                        value: false,
                        message: "Địa chỉ bị bỏ trống"
                    }
                },
                ["Tỉnh thành"]:{
                    empty: {
                        value: false,
                        message: "Tỉnh thành bị bỏ trống"
                    }
                },
                ["Quận huyện"]:{
                    empty:{
                        value: false,
                        message: "Quận huyện bị bỏ trống"
                    }
                },
                ["Phường xã"]:{
                    empty:{
                        value: false,
                        message: "Phường xã bị bỏ trống"
                    }
                },
                ["Nợ hiện tại"]:{
                    empty:{
                        value: true,
                    },
                    regex:{
                        value: /^[0-9]*$/,
                        message: "Nợ hiện tại phải là một số"
                    }
                },
                ["Tổng chi tiêu"]:{
                    empty:{
                        value: true,
                    },
                    regex:{
                        value: /^[0-9]*$/,
                        message: "Tổng chi tiêu là một số"
                    }
                },
                ["Ghi chú"]:{
                    empty:{
                        value: true,
                    },
                },
                ["Tags"]:{
                    empty:{
                        value: true
                    }
                }
            }
            let error = {
                [index]:{}
            };
            let i = 0;
            for(let key in validate){
                if(data[key]==undefined){
                    if(validate[key].empty.value && validate[key].regex==undefined){
                        continue;
                    }
                    if(!validate[key].empty.value){
                        error[index][key] = validate[key].empty.message;
                        i++;
                    }
                }else{
                    if(validate[key].regex!=undefined){
                        if(`${data[key]}`.match(validate[key].regex.value)==null){
                            error[index][key] = validate[key].regex.message;
                           i++;
                        }
                    }
                }
            }
            if(i!=0) errorArrRow.push(error);
        }
        function convertBirthDay(day){
            try{
                let isoDay = new Date(Date.UTC(0,0,day-1)).toISOString();
                let result = isoDay.split("T")[0];
                return result;
            }catch{
                return undefined;
            }
        }
        function tagsToArray(tags){
            try{
                let arr = tags.split(",")
                let result = [];
                for(let item of arr){
                    result.push(item.trim());
                }   
                return result;
            }catch{
                return [];
            }
        }
        //convert excel to DTO
        function excelToCreateCustomerParam(jsonData){
            let customerCreateParam = {
                fullName: jsonData["Tên khách hàng"] || '',
                customerCode: jsonData["Mã khách hàng"] || undefined,
                groupId: jsonData["Mã nhóm khách hàng"] || 0,
                phoneNumber: jsonData["Điện thoại"] || '',
                email: jsonData["Email"] || '',
                birthday: convertBirthDay(jsonData["Ngày sinh"]) || '',
                gender: jsonData["Giới tính"] || '',
                fax:jsonData["Fax"] || '',
                taxCode: jsonData["Fax"] || '',
                website: jsonData["Website"] || '',
                debtTotal: jsonData["Nợ hiện tại"] || 0,
                spendTotal: jsonData["Tổng chi tiêu"] || 0,
                employeeId: 6,
                description: jsonData["Mô tả"] || '',
                tags: tagsToArray(jsonData["Tags"]),
                // defaultPaymentMethodId: jsonData["Phương thức thanh toán mặc định"] || '',
                // defaultPricingPolicyId: jsonData["Chính sách giá mặc định"] || '',
                createAddressParam:{
                    fullName: jsonData["Người liên hệ"],
                    label: undefined,
                    phoneNumber: jsonData["Người liên hệ - SĐT"],
                    email: jsonData["Người liên hệ - Email"],
                    line1: jsonData["Địa chỉ"],
                    line2: undefined,
                    description:'',
                    wardId:-1,
                    wardName: jsonData["Phường xã"],
                    districtId: -1,
                    districtName: jsonData["Quận huyện"],
                    provinceId:-1,
                    provinceName: jsonData["Tỉnh thành"]
                }
            }
            listCreateCustomerParam.push(customerCreateParam);
        }
        function upload() {
            let files = document.getElementById('formFileCustomers').files;
            if(files.length==0){
                CustomerApp.IziToast.showErrorAlert("Không tồn tại file")
                alert("Please choose any file...");
                return;
            }
            let filename = files[0].name;
            let extension = filename.substring(filename.lastIndexOf(".")).toUpperCase();
            if (extension == '.XLS' || extension == '.XLSX') {
                return excelFileToJSON(files[0]);
            }else{
                alert("Please select a valid excel file.");
            }
        }
    
        function excelFileToJSON(file){
            try {
            let reader = new FileReader();
            reader.readAsBinaryString(file);
            reader.onload = function(e) {
        
                let data = e.target.result;
                let workbook = XLSX.read(data, {
                    type : 'binary'
                });
                let result = {};
                let nameSheet = ""
                workbook.SheetNames.forEach(function(sheetName, index) {
                    let roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                    if (roa.length > 0) {
                        result[sheetName] = roa;
                        if(index==0){
                            nameSheet = sheetName;
                        }
                    }
                });
                obj = result;
                flag = true;
                sheetName = nameSheet;
                }
            }catch(e){
                console.error(e);
            }
        }
    }
    </script>
</th:block>